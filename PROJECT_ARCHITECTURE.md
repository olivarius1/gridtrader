# 项目架构文档

## 系统概述

网格交易系统是一个基于Django + Django-Ninja的RESTful API系统，专门用于实现网格交易策略的管理和执行。

## 技术栈

- **后端框架**: Django 5.2.2
- **API框架**: Django-Ninja 1.4.3
- **数据库**: PostgreSQL
- **数据获取**: akshare 1.16.98
- **环境配置**: django-environ 0.12.0

## 应用模块架构

### 1. accounts (用户账户模块)

**职责**: 用户管理和资金账户管理

**核心模型**:
- `User`: 扩展的用户模型，包含资金信息
- `CommissionPlan`: 个性化佣金费率方案

**主要功能**:
- 用户认证和权限管理
- 资金账户管理（总资产、可用资金、冻结资金）
- 佣金费率个性化设置
- 费用计算工具（佣金、过户费、印花税）

### 2. stocks (股票标的模块)

**职责**: 股票基础数据和价格管理

**核心模型**:
- `Stock`: 股票/标的基本信息
- `StockPrice`: 历史价格数据
- `WatchList`: 用户自选股

**主要功能**:
- 支持多种标的类型（股票、ETF、基金、债券）
- 历史价格数据存储和查询
- 用户自选股管理
- 价格监控和提醒

### 3. trading (交易执行模块)

**职责**: 交易记录和持仓管理

**核心模型**:
- `TradingRecord`: 交易记录详情
- `Position`: 实时持仓信息

**主要功能**:
- 交易记录管理（买入/卖出）
- 自动费用计算和净额计算
- 持仓信息实时维护
- 成本价和盈亏计算

### 4. grid (网格交易核心模块)

**职责**: 网格交易策略的核心实现

**核心模型**:
- `GridStrategy`: 网格策略配置（1.0-2.3版本）
- `GridPlan`: 网格交易计划
- `GridLevel`: 网格价格等级
- `GridOrder`: 网格订单
- `GridTradePair`: 网格交易对
- `GridPerformanceSnapshot`: 性能快照
- `GridTemplate`: 配置模板
- `GridSimulation`: 策略模拟

**主要功能**:
- 多版本网格策略支持
- 自动网格等级计算
- 交易对管理和盈利跟踪
- 配置模板保存和共享
- 策略模拟和回测

**支持的策略版本**:
- 1.0: 基础网格
- 2.0: 进阶网格
- 2.1: 留利润策略
- 2.2: 逐格加码策略
- 2.3: 一网打尽策略

### 5. analytics (数据分析模块)

**职责**: 交易数据分析和绩效统计

**核心模型**:
- `ProfitLossRecord`: 多周期盈亏统计
- `TradingPerformance`: 交易绩效分析
- `DailyBalance`: 每日资产变化

**主要功能**:
- 多周期统计（日/周/月/季/年）
- 交易绩效指标计算
- 收益曲线数据支持
- 风险指标分析

## 模块间关系

```
┌─────────────┐    ┌──────────────┐    ┌─────────────┐
│   accounts  │    │    stocks    │    │   trading   │
│   (用户)    │────│   (标的)     │────│   (交易)    │
└─────────────┘    └──────────────┘    └─────────────┘
       │                   │                   │
       │                   │                   │
       │            ┌──────────────┐           │
       └────────────│     grid     │───────────┘
                    │  (网格策略)   │
                    └──────────────┘
                           │
                    ┌──────────────┐
                    │  analytics   │
                    │   (分析)     │
                    └──────────────┘
```

## 数据流向

1. **用户注册/登录** → accounts模块
2. **添加标的** → stocks模块
3. **创建网格计划** → grid模块（关联用户和标的）
4. **执行交易** → trading模块（网格订单转为实际交易）
5. **数据分析** → analytics模块（基于交易数据生成统计）

## API架构

使用Django-Ninja提供RESTful API服务：

- **主路由**: `/api/`
- **网格模块**: `/api/grid/`
- **认证**: 基于Django的用户认证系统
- **文档**: 自动生成的OpenAPI文档

## 部署建议

### 开发环境
- 使用SQLite或PostgreSQL本地数据库
- 启用DEBUG模式
- 使用Django开发服务器

### 生产环境
- 使用PostgreSQL数据库
- 配置Redis缓存
- 使用Gunicorn + Nginx部署
- 配置日志和监控

## 扩展计划

1. **实时数据**: 集成WebSocket实现实时价格推送(暂不, 可以考虑每10分钟获取一次价格)
2. **任务队列**: 使用Celery处理异步任务
3. **前端界面**: 开发Vue.js或React前端
4. **移动端**: 开发移动端应用
5. **风控系统**: 增加风险控制模块

## 代码质量

- 遵循PEP8代码规范
- 使用类型提示
- 完善的文档字符串
- 单元测试覆盖
- 代码review流程 